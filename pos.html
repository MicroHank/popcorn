<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çˆ†ç±³èŠ±éŠ·å”®å¾Œå° (POS)</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="assets/bootstrap-5.3.8-dist/css/bootstrap.min.css">
    <link href="assets/fonts/css2.css" rel="stylesheet">

    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Outfit', 'Noto Sans TC', sans-serif;
            padding: 20px;
        }

        .pos-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin-bottom: 15px;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 12px;
            transition: all 0.2s;
        }

        .item-row:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-color: #ddd;
        }

        .item-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #333;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .qty-display {
            font-size: 1.5rem;
            font-weight: 800;
            width: 60px;
            text-align: center;
            border: none;
            background: transparent;
        }

        .btn-ctrl {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            transition: transform 0.1s;
        }

        .btn-ctrl:active {
            transform: scale(0.95);
        }

        .status-bar {
            margin-top: 20px;
            padding: 10px;
            text-align: center;
            font-size: 0.9rem;
            color: #666;
            background: #f1f1f1;
            border-radius: 8px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
    </style>
</head>

<body>

    <div class="pos-container">
        <div class="header">
            <h2>ğŸ¿ è²©å”®è¨ˆæ•¸å™¨</h2>
            <p class="text-muted">å³æ™‚åŒæ­¥è‡³ Google Sheets</p>
        </div>

        <div id="items-list">
            <!-- Items injected here -->
        </div>

        <div class="mt-4">
            <label class="form-label text-muted small mb-1">ğŸ”‘ ç®¡ç†å¯†ç¢¼</label>
            <input type="password" id="pos-password" class="form-control rounded-pill mb-3" placeholder="è¼¸å…¥ SECRET_TOKEN">
        </div>

        <div class="d-grid gap-2">
            <button id="btn-force-save" class="btn btn-primary btn-lg rounded-pill">ç«‹å³å„²å­˜</button>
            <button id="btn-reload" class="btn btn-outline-secondary rounded-pill">é‡æ–°è®€å–</button>
        </div>

        <div class="status-bar" id="status-msg">
            æº–å‚™å°±ç·’
        </div>
    </div>

    <div class="loading-overlay" id="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <script src="assets/jquery/jquery-3.7.1.min.js"></script>
    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbz5qSfvk-8rtj-VUd66KIoWJtKkxKx5RzNOI6-bF0A6xvhu3rAqHgz6jAu96Bd-Mn8wpA/exec";

        // Items config
        const items = [
            { id: "popcorn_large", name: "çˆ†ç±³èŠ±å¤§ä»½" },
            { id: "popcorn_small", name: "çˆ†ç±³èŠ±å°ä»½" },
            { id: "soda", name: "ç¢³é…¸é£²" },
            { id: "combo", name: "è¶…å€¼çµ„åˆ" }
        ];

        let salesState = {
            "çˆ†ç±³èŠ±å¤§ä»½": 0,
            "çˆ†ç±³èŠ±å°ä»½": 0,
            "ç¢³é…¸é£²": 0,
            "è¶…å€¼çµ„åˆ": 0
        };

        // Render UI
        function renderItems() {
            const $container = $('#items-list');
            $container.empty();

            items.forEach(item => {
                const qty = salesState[item.name] || 0;
                const html = `
                    <div class="item-row">
                        <div class="item-name">${item.name}</div>
                        <div class="controls">
                            <button class="btn btn-outline-danger btn-ctrl btn-minus" data-name="${item.name}">-</button>
                            <input type="number" class="qty-display" data-name="${item.name}" value="${qty}">
                            <button class="btn btn-outline-success btn-ctrl btn-plus" data-name="${item.name}">+</button>
                        </div>
                    </div>
                `;
                $container.append(html);
            });
        }

        function updateStateFromDOM() {
            $('.qty-display').each(function () {
                const name = $(this).data('name');
                const val = parseInt($(this).val()) || 0;
                salesState[name] = val;
            });
        }

        // Logic
        $(document).ready(function () {
            // Load saved password
            const savedPassword = localStorage.getItem('pos_password');
            if (savedPassword) {
                $('#pos-password').val(savedPassword);
            }

            renderItems();
            loadSalesData();

            // Event Listeners
            $(document).on('click', '.btn-plus', function () {
                const name = $(this).data('name');
                salesState[name]++;
                updateUI(name);
            });

            $(document).on('click', '.btn-minus', function () {
                const name = $(this).data('name');
                if (salesState[name] > 0) {
                    salesState[name]--;
                    updateUI(name);
                }
            });

            $(document).on('change', '.qty-display', function () {
                const name = $(this).data('name');
                let val = parseInt($(this).val());
                if (val < 0) val = 0;
                salesState[name] = val;
            });

            $('#btn-force-save').click(() => {
                saveSalesData();
            });

            $('#btn-reload').click(() => {
                if (confirm('ç¢ºå®šè¦é‡æ–°è®€å–å—ï¼Ÿå°šæœªå„²å­˜çš„è®Šæ›´å°‡æœƒéºå¤±ã€‚')) {
                    loadSalesData();
                }
            });

            // Auto-save every 1 minute
            setInterval(() => {
                saveSalesData(true); // true = silent mode
            }, 60000);
        });

        function updateUI(name) {
            $(`input[data-name="${name}"]`).val(salesState[name]);
        }

        async function loadSalesData() {
            showLoading(true);
            setStatus('æ­£åœ¨è®€å–è³‡æ–™...');
            try {
                const res = await fetch(`${GAS_URL}?action=getSales`);
                const data = await res.json();

                // Update local state with remote data
                // Only update keys that exist in our config
                Object.keys(data).forEach(key => {
                    if (salesState.hasOwnProperty(key)) {
                        salesState[key] = parseInt(data[key]) || 0;
                    }
                });

                renderItems();
                setStatus('è³‡æ–™å·²åŒæ­¥ (æœ€æ–°è®€å–: ' + new Date().toLocaleTimeString() + ')');
            } catch (err) {
                console.error(err);
                setStatus('è®€å–å¤±æ•—: ' + err.message);
                alert('è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ˜¯ GAS è¨­å®š');
            } finally {
                showLoading(false);
            }
        }

        async function saveSalesData(silent = false) {
            if (!silent) showLoading(true);
            setStatus('æ­£åœ¨å„²å­˜...');

            try {
                const password = $('#pos-password').val();
                if (!password) {
                    throw new Error('è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼');
                }
                // Save password for convenience
                localStorage.setItem('pos_password', password);

                const payload = {
                    action: 'updateSales',
                    password: password,
                    sales: salesState
                };

                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                const result = await res.json();

                if (result.result === 'success') {
                    setStatus('å„²å­˜æˆåŠŸ (' + new Date().toLocaleTimeString() + ')');
                } else {
                    throw new Error(result.message || 'Unknown error');
                }
            } catch (err) {
                console.error(err);
                setStatus('å„²å­˜å¤±æ•—: ' + err.message);
                if (!silent) alert('å„²å­˜å¤±æ•—ï¼');
            } finally {
                if (!silent) showLoading(false);
            }
        }

        function showLoading(show) {
            if (show) $('#loading').fadeIn(200);
            else $('#loading').fadeOut(200);
        }

        function setStatus(msg) {
            $('#status-msg').text(msg);
        }
    </script>
</body>

</html>